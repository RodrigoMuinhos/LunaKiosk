services:
  # ==========================================
  # LunaCore - Authentication Service
  # ==========================================
  lunacore:
    build:
      context: ./projeto-Luna.code-workspace/LunaCore/lunacore
      dockerfile: Dockerfile
    container_name: lunacore
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - SERVER_PORT=8080
      - JWT_SECRET=${JWT_SECRET}
      - SPRING_DATASOURCE_URL=${NEON_LUNACORE_URL}
      - SPRING_JPA_HIBERNATE_DDL_AUTO=validate
      # Dentro do container, "localhost" aponta para o próprio LunaCore.
      # Para o proxy funcionar, use o hostname do serviço no docker network.
      - TOTEM_API_BASE_URL=http://totemapi:8081
    ports:
      - "8080:8080"
    networks:
      - lunavita-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ==========================================
  # LunaPay - Payment Processing Service
  # ==========================================
  lunapay:
    build:
      context: ./projeto-Luna.code-workspace/LunaPay/lunapay-api
      dockerfile: Dockerfile
    container_name: lunapay
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - SERVER_PORT=8082
      - JWT_SECRET=${JWT_SECRET}
      - SPRING_DATASOURCE_URL=${NEON_LUNAPAY_URL}
      - SPRING_JPA_HIBERNATE_DDL_AUTO=validate
      - LUNACORE_URL=${LUNACORE_URL}
      # Asaas Payment Gateway
      - ASAAS_SANDBOX_API_KEY=${ASAAS_SANDBOX_API_KEY}
      - ASAAS_SANDBOX_WALLET_ID=${ASAAS_SANDBOX_WALLET_ID}
      - ASAAS_PROD_API_KEY=${ASAAS_PROD_API_KEY}
      - ASAAS_PROD_WALLET_ID=${ASAAS_PROD_WALLET_ID}
      - ASAAS_ENVIRONMENT=${ASAAS_ENVIRONMENT}
    ports:
      - "8082:8082"
    depends_on:
      lunacore:
        condition: service_healthy
    networks:
      - lunavita-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8082/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ==========================================
  # TotemAPI - Clinical Data Service
  # ==========================================
  totemapi:
    build:
      context: ./projeto-Luna.code-workspace/LunaTotem/TotemAPI
      dockerfile: Dockerfile
    container_name: totemapi
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - SERVER_PORT=8081
      - JWT_SECRET=${JWT_SECRET}
      - SPRING_DATASOURCE_URL=${NEON_TOTEMAPI_URL}
      - SPRING_JPA_HIBERNATE_DDL_AUTO=validate
      - LUNACORE_URL=${LUNACORE_URL}
    ports:
      - "8081:8081"
    depends_on:
      lunacore:
        condition: service_healthy
    networks:
      - lunavita-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8081/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ==========================================
  # TotemUI - Frontend (Next.js)
  # ==========================================
  totemui:
    build:
      context: ./projeto-Luna.code-workspace/LunaTotem/TotemUI
      dockerfile: Dockerfile
    container_name: totemui
    environment:
      - NODE_ENV=production
      # Use same-origin in the browser; Next rewrites will proxy to TotemAPI.
      - NEXT_PUBLIC_LUNATOTEM_API_URL=/
      # Optional override (defaults to http://totemapi:8081)
      - TOTEM_API_PROXY_URL=http://totemapi:8081
    ports:
      - "3000:3000"
    depends_on:
      - lunacore
      - totemapi
      - lunapay
    networks:
      - lunavita-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://127.0.0.1:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

# ==========================================
# Networks
# ==========================================
networks:
  lunavita-network:
    driver: bridge
    name: lunavita-network

